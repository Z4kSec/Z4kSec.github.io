<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="IoctlHunter Release (v0.2)" /><meta property="og:locale" content="en" /><meta name="description" content="A Bit of Context" /><meta property="og:description" content="A Bit of Context" /><link rel="canonical" href="https://z4ksec.github.io/posts/ioctlhunter-release-v0.2/" /><meta property="og:url" content="https://z4ksec.github.io/posts/ioctlhunter-release-v0.2/" /><meta property="og:site_name" content="Zak’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-07T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="IoctlHunter Release (v0.2)" /><meta name="twitter:site" content="@_ZakSec" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-07T22:09:32+00:00","datePublished":"2023-12-07T00:00:00+00:00","description":"A Bit of Context","headline":"IoctlHunter Release (v0.2)","mainEntityOfPage":{"@type":"WebPage","@id":"https://z4ksec.github.io/posts/ioctlhunter-release-v0.2/"},"url":"https://z4ksec.github.io/posts/ioctlhunter-release-v0.2/"}</script><title>IoctlHunter Release (v0.2) | Zak's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Zak's blog"><meta name="application-name" content="Zak's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Zak's blog</a></div><div class="site-subtitle font-italic">Pentesting and RedTeaming stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Z4kSec" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_ZakSec" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>IoctlHunter Release (v0.2)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>IoctlHunter Release (v0.2)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1701907200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 7, 2023 </em> </span> <span> Updated <em class="" data-ts="1701986972" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 7, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/_ZakSec">Zak</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2037 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><h2 id="a-bit-of-context"><span class="mr-2">A Bit of Context</span><a href="#a-bit-of-context" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://github.com/Z4kSec/IoctlHunter">IoctlHunter</a> is a command-line tool designed to simplify the analysis of IOCTL calls made by userland software targeting Windows drivers.</p><p><strong>TL;DR: Here are the <a href="#demo-with-powertools">videos demonstrating the usage of IoctlHunter</a></strong></p><p>From a cybersecurity perspective, IoctlHunter empowers security researchers to identify IOCTL calls that could potentially be reused in standalone binaries to perform various actions, such as privilege escalation (EoP) or killing Endpoint Detection and Response (EDR) processes.</p><p>This technique, also known as BYOVD (Bring Your Own Vulnerable Driver), involves embedding a signed vulnerable driver within a binary. Once deployed on a targeted system, the binary loads the driver and sends IOCTL calls to it to execute specific offensive actions with kernel-level privileges.</p><p>This article was written in continuity of a <a href="https://alice.climent-pommeret.red/posts/process-killer-driver/">blog post</a> written by <a href="https://twitter.com/AliceCliment">Alice</a>. In this awesome article, Alice explains how it is possible to perform a static analysis of Windows drivers to retrieve features allowing a userland software to kill protected processes such as EDR ones.</p><p>While reading it, it definitely challenged me to build a tool that enables lazy reverse engineers to easily discover drivers providing juicy features for offensive use cases.</p><p>We will not deep dive into how drivers work or describe all their interactions with userland processes in detail. <strong>Thus, I strongly recommend reading Alice’s blog post to gain a deep understanding of how drivers work and how to exploit them</strong>.</p><p>However, before understanding how IoctlHunter works, let me introduce a few key concepts.</p><h2 id="driver-loading"><span class="mr-2">Driver Loading</span><a href="#driver-loading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First, drivers must be loaded on the running Windows system. This can be achieved by running the following command lines:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$&gt; sc.exe create MyDriver binPath= C:\windows\temp\MyDriver.sys type= kernel
$&gt; sc.exe start MyDriver
</pre></table></code></div></div><p>As you can see, the load of a driver consist in starting a service. Thus, the same result can be achieved by performing the following steps:</p><ol><li>Create a registry path within <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\MyDriver</code> (see. the function <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regcreatekeyexw">RegCreateKeyExW</a> from <code class="language-plaintext highlighter-rouge">Advapi32.dll</code>)<li>Set multiple registry key within it including the <code class="language-plaintext highlighter-rouge">ImagePath</code> which is a string pointing to the absolute file path where the driver binary is stored on the disk (see. the function <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa">RegSetValueExA</a> from <code class="language-plaintext highlighter-rouge">Advapi32.dll</code>)<li>Start the service and load the driver by specifying the newly created registry path (see. the function <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwloaddriver">NtLoadDriver</a> from <code class="language-plaintext highlighter-rouge">ntdll.dll</code>)</ol><p>Once your driver successfully loaded, you will need to open a <code class="language-plaintext highlighter-rouge">handle</code> on it to interact with it. This can be achieved by calling function such as <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFileA</a></p><blockquote class="prompt-info"><p>The tool <a href="https://github.com/Yaxser/Backstab">Backstab</a>, developed in C++ by <a href="https://twitter.com/Yas_o_h">Yasser</a>, provide a very nice implementation of arbitrary driver loading and unloading there: <a href="https://github.com/Yaxser/Backstab/blob/master/Backstab/Driverloading.c">Driverloading.c</a></p></blockquote><h2 id="run-kernel-land-code"><span class="mr-2">Run kernel land code</span><a href="#run-kernel-land-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Once you obtain a handle on your loaded driver, you are now able to send instruction to it. Indeed, drivers can exposed specific functions to be run on the kernel side.</p><p>In order to specify which function must be executed, userland programs can send the IOCTL (I/O control code). This 32 bits value is bascically dedicated to indicate to the driver which function must be called by within the drivers code.</p><p>The <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> function (see. <a href="https://learn.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">MS documentation</a>) provides this interface between user land programs and the driver code running in the kernel side.</p><p>Few parameters are required to do the stuff:</p><ul><li>A handle to the targeted driver (<code class="language-plaintext highlighter-rouge">hDevice</code>)<li>The transmitted IOCTL code (<code class="language-plaintext highlighter-rouge">dwIoControlCode</code>)<li>The associated transmitted data (<code class="language-plaintext highlighter-rouge">lpInBuffer</code>) and its size (<code class="language-plaintext highlighter-rouge">nInBufferSize</code>)<li>The returned data (<code class="language-plaintext highlighter-rouge">lpOutBuffer</code>, <code class="language-plaintext highlighter-rouge">nOutBufferSize</code>)</ul><p>Some examples of interesting IOCTL calls involve transmitting basic data in the <code class="language-plaintext highlighter-rouge">lpInBuffer</code> parameter, such as an integer specifying a process to be terminated. However, the typical usage of <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> often requires submitting a custom C-like structure in this parameter, containing various data types. Understanding how to construct such a structure may necessitate static analysis of the driver.</p><p>In such case, a good approach is first to identify the IOCTl code related to the function that we are intersting in. Then, with a reverse software like cutter, ghidra or IDA, we can start by looking for the Driver main function and browse the code until we found “a switch case” pattern were the dispatching between all IOCTL codes is made between all driver implemented functions (not always the case!).</p><p><a href="/assets/img/alice-driver-switchcase.png" class="popup img-link "><img data-src="/assets/img/alice-driver-switchcase.png" alt="Alice's example of switch case dispatching IOCTL code on a driver side" class="lazyload" data-proofer-ignore></a></p><center><u><i>Alice's example of switch case dispatching IOCTL code on a driver side</i></u></center><p><br /></p><p>Finally, once a static comparison between our IOCTL code is made, we are not that far of the paramater containing the <code class="language-plaintext highlighter-rouge">lpInBuffer</code> pointer. If you look for data pointed by it, you should be able to analyse the provided structure.</p><h2 id="chain-it"><span class="mr-2">Chain it</span><a href="#chain-it" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As we’ve discussed, multiple calls can be intercepted to dynamically retrieve drivers loaded by a program based on changes to registry keys.</p><p>Moreover, <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> calls contain sufficient information to help us retrieve the portion of driver code that will be executed, the data sent as parameters to perform tasks, and the size of this data.</p><p>In short, from a “user land” perspective, a security researcher can intercept all the previously mentioned Win32 functions to dynamically obtain the following information:</p><ul><li>Automatically detect loaded drivers.<li>Intercept IOCTL calls and the associated data.<li>Retrieve the driver using the handle passed as a parameter to <code class="language-plaintext highlighter-rouge">DeviceIoControl</code>.</ul><p>With this information, you can extract necessary data in a lab while analyzing a tool with a driver capable of executing kernel-level actions for offensive purposes.</p><p>Once you’ve gathered all this information by intercepting these functions or by statically reversing the driver, you’ll have everything needed to create a binary that loads the driver and sends the correct IOCTL with the appropriate data.</p><p>However, in real world scenarios, multiple drivers can be dynamically loaded and called by a single executable. This can make it challenging, with the hooking approach, to identify the IOCTLs that match the observed features while using tools not specifically designed for this purpose. That’s why I began developing IoctlHunter.</p><h2 id="ease-the-process-with-ioctlhunter"><span class="mr-2">Ease the process with IoctlHunter</span><a href="#ease-the-process-with-ioctlhunter" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Unlike some of today’s tools, IoctlHunter differs from static driver analysis approaches. The tool aim is to execute a binary that is likely reliant on drivers providing interesting offensive features. By exploring the various options presented by such programs, IoctlHunter helps in monitoring the IOCTL calls that occured.</p><p>The mindset to adopt when using IoctlHunter is a bit like using BurpSuite to analyze a website. You navigate to the options that might interest you and look in IoctlHunter for the potential associated IOCTL.</p><p>The tool provides several essential pieces of information to replay an IOCTL, thanks to the <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> function (see <a href="https://learn.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">MS documentation</a>):</p><ul><li>The target driver<li>The transmitted IOCTL code (<code class="language-plaintext highlighter-rouge">dwIoControlCode</code>)<li>The associated transmitted data (<code class="language-plaintext highlighter-rouge">lpInBuffer</code>) and its size (<code class="language-plaintext highlighter-rouge">nInBufferSize</code>)<li>The returned data (<code class="language-plaintext highlighter-rouge">lpOutBuffer</code>, <code class="language-plaintext highlighter-rouge">nOutBufferSize</code>)</ul><p>With this information, it is possible to conduct a static analysis of the driver to scrutinize the associated code in detail, starting from the IOCTL code. However, it is also possible to directly replay this IOCTL call if its usage appears straightforward.</p><p><a href="/assets/img/dyn-load-driver.png" class="popup img-link "><img data-src="/assets/img/dyn-load-driver.png" alt="Detection of a dynamically loaded driver" class="lazyload" data-proofer-ignore></a></p><center><u><i>Detection of a dynamically loaded driver</i></u></center><p><br /></p><p><a href="/assets/img/ioctl-kill.png" class="popup img-link "><img data-src="/assets/img/ioctl-kill.png" alt="IoctlHunter output providing &quot;dwIoControlCode&quot; and hexdump of the &quot;lpInBuffer&quot; data" class="lazyload" data-proofer-ignore></a></p><center><u><i>IoctlHunter output providing "dwIoControlCode" and hexdump of the "lpInBuffer" data</i></u></center><p><br /></p><p>Successful use of IoctlHunter empowers Red Teamers and Penetration Testers to create a standalone executable that installs a specific driver and issues one or more IOCTL calls to perform various tasks. The advantage lies in the ability to execute signed drivers with kernel privileges, and to exploit useful features in an offensive way.</p><p>Obviously such standalone BYOVD binaries requires the <code class="language-plaintext highlighter-rouge">SeLoadDriverPrivilege</code> flags to be able to do the magic!</p><h2 id="how-it-works"><span class="mr-2">How it works?</span><a href="#how-it-works" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As IoctlHunter base its analysis on hooking, I decided to use the most advanced and easily scriptable tool to do this job: <a href="https://frida.re/docs/home/">Frida</a>. Frida is basically a dynamic instrumentation tool which support Python to script with. Its main usage consists in injecting code into a process and to hook functions within running processes, facilitating a debugging, as well as reverse engineering. I am sure lots of you already used it for mobile pentests (certificate pinning bypass FTW!) or to easily reverse thick clients.</p><p>From this awesome libraries, IoctlHunter is able to spawn or attach to an existing process to be analyse. Then, a RPC communication is established between the two process and IoctlHunter is able to hook useful functions in order to collect all IOCTL calls, apply fynamic filters on them and much more!</p><p>The full developped Frida script can be found there: <a href="https://github.com/Z4kSec/IoctlHunter/blob/main/ioctl_hunter/frida/script.ts">script.ts</a></p><h2 id="demo-with-powertools"><span class="mr-2">Demo with PowerTools</span><a href="#demo-with-powertools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In Alice’s blog post, titled “<a href="https://alice.climent-pommeret.red/posts/process-killer-driver/">Finding and Exploiting Process Killer Drivers with LOL for $3000</a>,” she demonstrated how a static reverse engineering analysis of the <code class="language-plaintext highlighter-rouge">kEvP64.sys</code> driver used by the <code class="language-plaintext highlighter-rouge">PowerTool</code> software allowed her to develop a <a href="https://github.com/xalicex/Killers">process killer tool</a> that could terminate protected processes with kernel-level privileges.</p><p>The following video demonstrates how IoctlHunter makes it easy to identify all the elements needed to terminate protected processes using the same tool:</p><video style="display:block; width:100%; height:auto;" autoplay="" controls="" loop="loop"> <source src="/assets/video/demo_ioctlhunter_powertool.mp4" type="video/mp4" /> </video> <center><u><i>Hunting for IOCTLs on PowerTool</i></u></center><p><br /></p><p>Subsequently, using the information obtained, <a href="https://github.com/Z4kSec/IoctlHunter/tree/main/example">a Golang package</a> provided in the IoctlHunter repository allows you to load and replay the IOCTL calls:</p><video style="display:block; width:100%; height:auto;" autoplay="" controls="" loop="loop"> <source src="/assets/video/demo_ioctlhunter_golang_ex_killer.mp4" type="video/mp4" /> </video> <center><u><i>Killing protected processes thanks to PowerTool driver</i></u></center><p><br /></p><h2 id="limitiations"><span class="mr-2">Limitiations</span><a href="#limitiations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It is important to underline that IoctlHunter is not designed to supplant traditional static or dynamic reverse engineering methods used for vulnerability discovery in drivers. Instead, it serves as a complementary tool to help in the dynamic identification of specific IOCTL calls information, providing additional insights into the behavior of drivers loaded by a given software. As describe in this article, the complexity resides in the identification of the data structure linked to the <code class="language-plaintext highlighter-rouge">lpInBuffer</code> data buffer.</p><p>Furthermore, the tool primarily involves injecting itself into processes for analysis. However, this approach may not work directly when targeting processes are protected with anti-tampering mechanisms. For instance, EDR (Endpoint Detection and Response) processes may not allow injection via Frida without the prior use of a specific driver to open a handle on these protected processes.</p><blockquote class="prompt-tip"><p>IoctlHunter is designed to gather IOCTL data in a controlled lab environment. This enables the disabling of security mechanisms and the utilization of existing techniques to inject into protected processes.</p></blockquote><p>Finally, the actual version of IoctlHunter allows for hooking various functions within the Windows API that have multiple implementations and/or function prototypes (see blue box on the screenshot below). This diversity arises from the existence of functions suffixed with either ‘W’ or ‘A’, with ‘W’ denoting wide-character (Unicode) and ‘A’ for ANSI character functions, depending on the string encoding used. Additionally, some functions may have ‘Ex’ suffixed, which generally indicates an extended version of the function with additional features or parameters.</p><p>Furthermore, certain functions may be prefixed with ‘Nt’ or ‘Zw’, signifying native API calls that interact more directly with the operating system’s kernel. However, these functions ultimately call each other, and not every program necessarily calls the same function (see green box on the screenshot below). IoctlHunter is designed to hook the most common functions by default to avoid duplication. In cases where it’s necessary, the <code class="language-plaintext highlighter-rouge">--all-symbols</code> option allows for hooking all ‘versions’ of a function but may result in duplicate function calls.</p><p><a href="/assets/img/functions-called-frida-trace.png" class="popup img-link "><img data-src="/assets/img/functions-called-frida-trace.png" alt="Hooked functions with Frida" class="lazyload" data-proofer-ignore></a></p><center><u><i>Hooked functions with Frida</i></u></center><p><br /></p><h2 id="whats-next"><span class="mr-2">What’s next?</span><a href="#whats-next" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First, it could be interesting to facilitate the ability to replay IOCTL calls. When the <code class="language-plaintext highlighter-rouge">--output</code> parameter is enabled, the generated file contains a base64 encoded buffer in the data provided through the <code class="language-plaintext highlighter-rouge">lpInBuffer</code> parameter of the <code class="language-plaintext highlighter-rouge">DeviceIoControl</code> function. It might be cool to introduce a feature that allows the replay of such IOCTL calls on the same driver for debugging purposes.</p><p>The second point of improvement is not directly related to IoctlHunter. Instead, it concerns the project <a href="https://twitter.com/M_haggis">Loldrivers.io</a> created this year by <a href="https://twitter.com/M_haggis">The Haag</a>, which provides an extensive database of known vulnerable drivers. This database serves as an excellent starting point for identifying IOCTL vulnerabilities in BYOVD (Bring Your Own Vulnerable Driver) attacks (see Alice’s tool <a href="https://github.com/xalicex/LOLDrivers_finder">LOLDrivers_finder</a>).</p><p>However, the Loldrivers project does not offer detailed information regarding specific vulnerable features or how to exploit them (IOCTL codes, required input data, etc.). Obviously, the collection of this information typically involves significant reverse engineering work. Still, it might be beneficial to reference such details when available, similar to how it’s done for PowerTools, ProcExp512, RTCore64, and other vulnerable drivers. This could assist in the development of tools for drivers already known to be vulnerable (and potentially blacklisted by Microsoft). Additionally, it might contribute to the creation of more precise detection rules based on EDR telemetry (not tested!)</p><h2 id="acknowledgements"><span class="mr-2">Acknowledgements</span><a href="#acknowledgements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://twitter.com/AliceCliment">Alice</a> for her <a href="https://alice.climent-pommeret.red/posts/process-killer-driver/">blog post</a> and tools regarding drivers<li><a href="https://twitter.com/M_haggis">The Haag</a> for the <a href="https://twitter.com/M_haggis">Loldrivers.io</a> project<li><a href="https://twitter.com/Yas_o_h">Yasser</a> for the tool <a href="https://github.com/Yaxser/Backstab">Backstab</a><li>The <a href="https://learn.microsoft.com/en-us/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">Microsoft</a> and <a href="https://frida.re/docs/home/">Frida</a> documentations</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tools/'>Tools</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ioctlhunter/" class="post-tag no-text-decoration" >ioctlhunter</a> <a href="/tags/ioctl/" class="post-tag no-text-decoration" >ioctl</a> <a href="/tags/drivers/" class="post-tag no-text-decoration" >drivers</a> <a href="/tags/pentest/" class="post-tag no-text-decoration" >pentest</a> <a href="/tags/reverse/" class="post-tag no-text-decoration" >reverse</a> <a href="/tags/frida/" class="post-tag no-text-decoration" >frida</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=IoctlHunter%20Release%20(v0.2)%20-%20Zak's%20blog&url=https%3A%2F%2Fz4ksec.github.io%2Fposts%2Fioctlhunter-release-v0.2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=IoctlHunter%20Release%20(v0.2)%20-%20Zak's%20blog&u=https%3A%2F%2Fz4ksec.github.io%2Fposts%2Fioctlhunter-release-v0.2%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fz4ksec.github.io%2Fposts%2Fioctlhunter-release-v0.2%2F&text=IoctlHunter%20Release%20(v0.2)%20-%20Zak's%20blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ioctlhunter-release-v0.2/">IoctlHunter Release (v0.2)</a><li><a href="/posts/masky-release-v0.0.3/">Masky release (v0.0.3)</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentest/">pentest</a> <a class="post-tag" href="/tags/ad/">AD</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/certificates/">certificates</a> <a class="post-tag" href="/tags/drivers/">drivers</a> <a class="post-tag" href="/tags/dump/">dump</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/ioctl/">ioctl</a> <a class="post-tag" href="/tags/ioctlhunter/">ioctlhunter</a> <a class="post-tag" href="/tags/lsass/">lsass</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/masky-release-v0.0.3/"><div class="card-body"> <em class="small" data-ts="1660867200" data-df="ll" > Aug 19, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Masky release (v0.0.3)</h3><div class="text-muted small"><p> Masky is a python library providing an alternative way to remotely dump domain users’ credentials thanks to an ADCS. A command line tool has been built on top of this library in order to easily har...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/masky-release-v0.0.3/" class="btn btn-outline-primary" prompt="Older"><p>Masky release (v0.0.3)</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentest/">pentest</a> <a class="post-tag" href="/tags/ad/">AD</a> <a class="post-tag" href="/tags/adcs/">adcs</a> <a class="post-tag" href="/tags/certificates/">certificates</a> <a class="post-tag" href="/tags/drivers/">drivers</a> <a class="post-tag" href="/tags/dump/">dump</a> <a class="post-tag" href="/tags/frida/">frida</a> <a class="post-tag" href="/tags/ioctl/">ioctl</a> <a class="post-tag" href="/tags/ioctlhunter/">ioctlhunter</a> <a class="post-tag" href="/tags/lsass/">lsass</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/_ZakSec">Zak</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
